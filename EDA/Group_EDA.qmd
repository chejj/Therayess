---
title: "Exploratory Data Analysis"
subtitle: "Metagenomic Analysis of Fecal Samples as a Differential Diagnostic Tool for Colorectal Cancer"
format: 
  pdf:
    header-includes:
      - \setkomafont{title}{\Large\bfseries}
      - \setkomafont{author}{\normalsize}
      - \setkomafont{date}{\small}
author:
    - name: Kaitlyn Schisler
    - name: Cory Spern
    - name: Faith Shipman
    - name: Jacob Anderson
---

# Delete Before Submitting

### Assignment Guidelines from Canvas

[**Step 1: EDA Objectives & Preparing data**]{.underline}

-   define at least 3 EDA objectives to investigate (necessary variables? distributions conducive to modelling? data quality issues? is data suitable? representative of population?)

-   There's a document available about what's good to do for EDA on canvas that we can look at if needed

[**Step 2: Conduct EDA**]{.underline}

-   Plots/visualizations, summary stats, tables

-   document findings clearly

-   Code, additional plots & tables that aren't the main talking points can be included in an appendix section.

[**Step 3: EDA Report (Single spaced, 12 pt. font)**]{.underline}

-   **Introduction to Data (1-2 page)**\
    Provide an overview of your dataset, including its source (with relevant links), purpose, and your rationale for selecting it. Clearly state your EDA objectives and briefly describe the EDA methods used. Explain the importance of EDA in the context of your overall project.

    -   Pull from methods section from proposal/revised proposal and the project statement, good depth there on selection of the data and why we chose the data/methods.

-   **Exploratory Data Analysis (4-5 pages)**\
    This is the core of your report. Present your findings using relevant summary statistics, tables, and visualizations. Ensure each EDA objective is addressed clearly and supported by appropriate evidence from your analysis.

    -   Flow of this section will be important. We can play with the flow once everyone's section is complete.

-   **Summary (1-2 pages)**\
    Summarize your key findings and highlight the main takeaways from your EDA. Describe the next steps for your project, including how the insights gained from EDA will inform your choice of data modeling techniques for the main analysis. Briefly outline which techniques you plan to implement next and why.

### General Notes

-   Potential flow of our EDA section: Data Availability & Selection → Metadata Analysis → Taxa & Pathway Analysis → Data Limitations

    -   Data Availability

        -   What does the whole cMD3 offer in its standardized data, including how Bioconductor data works (`summarizedExperiments` vs `TreeSummarizedExperiments`)?

        -   What data remains, what could be answered, what can still be explored?

        -   ***Our original plan was to include metastases, which our data set has none so that is no longer possible***, so that could be mentioned here in this EDA section.

    -   Metadata EDA

        -   The factors we mentioned in our proposals (ie age, sex, geography/ethnicity, diet, antibiotics, etc)

            -   What has too little to give real meaning behind trends we see?

        -   For geography, the top 3 affected countries by CRC are represented in our data set, which is good. We should note that we are missing representations from certain continents

    -   Taxa vs pathways

        -   what we can do now (personal machines) vs what we need to do later on the HPC cluster (Sol)

    -   Data Limitations

        -   What gets lost once we filter it with our exclusionary criteria?

        -   What would be unable to answer with what we have, and what gaps would remain to be filled?

------------------------------------------------------------------------

------------------------------------------------------------------------

```{r, echo=FALSE}
#| label: Setup
source("Qualifying_Studies_List.R")
suppressPackageStartupMessages({
  library(tidyverse)
  library(knitr)
  library(kableExtra)
  library(patchwork)

  library(vegan)
  library(mia)
  library(scater)
  library(lefser)

  library(grid)
  library(gridExtra)
})

progression_order <- c(
  "HC",
  "PA",
  "PA+",
  "PA-M",
  "CRC",
  "CRC+",
  "CRC-H",
  "CRC-M", 
  "Other"
)

progression_colors <- c(
  "HC" = "#539deb",
  "PA" = "#e4e85b",
  "PA+" = "#e8a25b",
  "CRC" = "#cf1919",
  "CRC+" = "#8f0000",
  "CRC-M" = "#4d0404",
  "CRC-H" = "#520f76",
  "Other" = "#aaa3a3"
)

qualifying_studies <- qualifying_studies %>% 
  mutate(
    disease_class = factor(disease_class, levels = progression_order)
  )
```

### Introduction

#### Glossary

##### Diagnostic Categories

+----------------------------------+-------------------------------------------------------------------------+
| Abbreviation                     | Description                                                             |
+==================================+=========================================================================+
| HC                               | Healthy control                                                         |
+----------------------------------+-------------------------------------------------------------------------+
| PA                               | Polyp / adenoma                                                         |
+----------------------------------+-------------------------------------------------------------------------+
| PA+                              | Polyp / adenoma with comorbidities                                      |
+----------------------------------+-------------------------------------------------------------------------+
| CRC                              | Colorectal cancer                                                       |
+----------------------------------+-------------------------------------------------------------------------+
| CRC-H                            | History of colorectal cancer with resection                             |
+----------------------------------+-------------------------------------------------------------------------+
| CRC+                             | Colorectal cancer with comorbidities                                    |
+----------------------------------+-------------------------------------------------------------------------+
| Other                            | Any diagnosed disease without current or history of CRC-related growths |
+----------------------------------+-------------------------------------------------------------------------+

### Exploratory Data Analysis

#### Data Availability (Jake)

#### Metadata Analysis

Of great benefit to having the cMD3 database is the standardization of the metadata, allowing for the analysis of potential confounding variables for biases and major discrepancies in the data that may influence the results and interpretations downstream. With prior evidence supporting age, gender, diet, geographical location, and BMI as factors that influence the relative risk of CRC (Dakal et al., 2025; O’Keefe, 2016; Singh et al., 2017), they are important variables to consider in our EDA and to sources of distribution bias or significance.

All samples included contain information regarding the age and gender, which is important considering they are some of the factors in CRC screening and preventative care (Cancer Over Time, n.d.; Duan et al., 2022; Siegel et al., 2025). Summary statistics were conducted (Appendix 1-A), showing a mean age of 59, standard deviation of 14.75, and median of 63, suggesting a skew in this continuous variable. When faceted by gender (Appendix 1-B), aside from the proportion of males and females being statistically different from each other (41.1% female, p = 5.821e-14, Appendix 1-B and 3-A), the median, mean, and quartiles are not remarkably different. A histogram (Figure 1-A) and box plot by CRC progression classifier (Figure 1-B) were generated to corroborate this information, checking for extreme skewedness (supporting Q-Q plot available in Appendix 2-A). These show that while there is a slight left tailed skew in age overall with a bimodal pattern, seemingly caused by the healthy controls visible in the box plot, it is not to an extreme that would harm our final model detrimentally. Random Forest models are robust to unbalanced data (Bradter et al., 2022). Skew and variance of age was also checked between the sexes via a faceted histogram, which can be found in the supplementary visualizations (Appendix 2-B). Since the sample size is large, the central limit theorem allows for an ANOVA to be performed despite the slight skew, which was done to a 95% confidence level. This was to assess if there is a statistical difference in the mean age of the groups as a compliment to the box plot (Appendix 3-B). The p-value was \<2e-16, and a follow-up Tukey’s Honest Significant Difference (HSD) test was conducted to determine which pairings were significantly different from each other. The following pairings with "HC" were statistically different: "Other", "PA", "PA+", "CRC", and "CRC+" (all p-values \<0.000, Appendix 3-B). All other differences in age between the CRC progression classifiers showed no statistical significance at a 95% confidence interval.

After checking normality of the data, the age was divided into decades, with those 18 and 19 years old included in the 20-29 group to avoid a decade being visualized with only two years represented, and all those 80 years or older being grouped together as there was only one individual above 89 years. The two least represented decades in this study will be the 80+ and 30-39 decades (2.7% and 4.0%, respectively) and the three most represented being 60-69, 70-79, and 50-59 (34.4%, 21.8%, 19.9%, respectively; Appendix 1-C). Figure 1-C represents this data in proportions for easier comparisons across the decades, faceted by gender, as it is well established that males have a higher relative risk of CRC than females (Colorectal Cancer Statistics, n.d.; Duan et al., 2022). This pattern is reflected across most age groups in our data, particularly from 30-79. Furthermore, visually there are less samples with recorded comorbidities, as well as less "PA" compared to "CRC" and "HC", overall.

```{r, echo=FALSE}
#| label: Age Normality & CRC Variation across Age/Gender
#| fig-width: 14
#| fig-height: 7
#| fig-dpi: 500
# ---

# NORMALITY ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
#########################################

# Histogram
###########
normality1 <- qualifying_studies %>%
  # Set Up
  # ------
filter(!is.na(age)) %>%
  # Plotting
  # --------
ggplot(aes(x = age)) + 
  geom_histogram(bins=20) + 
  # Labeling
  #---------
labs(title = "Distribution of Age: Overall", x = "Age", y = "Count") +
  theme(plot.title = element_text(hjust = 0, size = 10), 
        axis.title = element_text(size = 10))

# Box Plot: Normality by CRC Category
#####################################
normality2 <- qualifying_studies %>%   
  # Set Up   
  # ------   
  filter(!is.na(age)) %>%   
  # Plotting   
  # --------   
  ggplot(aes(x=disease_class, y=age)) +    
  geom_boxplot(outlier.shape = NA) +   
  geom_jitter(alpha = 0.07, width = 0.15) +   
  stat_summary(fun = mean, geom = "point", shape = 20, size = 5, color = "red") +
  # Labeling   
  #--------- 
  labs(title = "Distribution of Age: By CRC Progression Classifier", 
       x = "CRC Progression Classifier", y = "Age") +
  theme(plot.title = element_text(hjust = 0, size = 10), 
        axis.title = element_text(size = 10))

# CRC ACROSS AGE/GENDER ~~~~~~~~~~~~~~~~~
#########################################

# Gendered Barplot: Proportions
###############################
decade1 <- qualifying_studies %>%
  # Set Up
  # ------
filter(!is.na(age_decade), !is.na(gender)) %>%
  # Plotting
  # --------
ggplot(aes(x = age_decade, fill = disease_class)) + 
  geom_bar(position = "fill") +
  scale_fill_manual(values = progression_colors, 
                    name = "CRC Progression \nClassifiers") +
  facet_wrap(~gender) +
  # Labeling
  #---------
labs(title = "CRC Progression Proportion by Age Decade, Grouped by Gender", 
     x = "Age by Decade", y = "Proportion") +
  theme(plot.title = element_text(size = 12))

###################
# Display Patchwork
###################
layout1 <- c( # t, l , b = t, r = l
  area(1, 1, 2, 2), 
  area(1, 3, 2, 4),
  area(3, 1, 5, 4), 
  area(3, 5, 5, 5)
)

#plot(layout1)

age_gender_caption <- str_wrap(
  "(A) Histogram demonstrating a bimodal age distribution with a secondary peak near 25 years and a primary peak near 60 years. 
   (B) Box plot of age across CRC progression classifiers, with jittered transluscent points to demonstrate spread of the sample. The red dot represents the mean, the line represents the median.
   (C) Bar plot displaying the gender faceted proportion of CRC progression classifiers across each decade. Notable differences include and visual increase in HC from 18-69 for females, and increased PA and CRC/CRC+ across most decades in males.", 
  width = 200
)

normality1 + normality2 + decade1 + guide_area() + 
  plot_layout(design = layout1, guides = "collect", widths = c(1,1,1,1,0.7)) +
  plot_annotation(
    title = "Figure 1: Age Normality & CRC Variation across Age and Gender",
    tag_levels = "A",
    caption = age_gender_caption
  ) &
  theme(
        plot.title = element_text(hjust = 0, size = 14),
        plot.caption = element_text(hjust = 0, size = 12), 
        legend.key.size = unit(0.4, "cm"), 
        legend.title = element_text(size = 12)
  )
```

Geographical location and consequently diet are also well established to be linked to CRC development (Dakal et al., 2025; Li et al., 2025; Singh et al., 2017). The three most affected countries by CRC—Japan, the United States, and China (Colorectal Cancer Statistics, n.d.; Worldwide Cancer Data, n.d.)—are well represented in this multi-cohort study at 38.9%, 17.0%, and 7.2% respectively (Figure 2-A, Appendix 1-D). This is important for our study to ensure that our results and model will be applicable to the most vulnerable target populations. Within these three target countries, there is representation from 6 of our classifiers, visible in Figures 2-B and 2-C: "Other", "HC", "PA", "CRC", "CRC+", and "CRC-H". The only unrepresented classifier is "PA+". Country is often closely tied to diet, however it is often not collected as a data point in studies, which is reflected in this data set, with only 276 data points containing information regarding diet, approximately 98.4% classified as omnivores and the remainder (10 samples) representing vegetarians, which may not be enough data points to investigate variability in diet as a factor in CRC progression, as it may over inflate proportions of different stages of the disease, like in various visualizations attempted (Appendix 2-C).

```{r, echo=FALSE}
#| label: Countries Associations
#| fig-width: 14
#| fig-height: 6
#| fig-dpi: 500
# ---

# Countries ~~~~~~~~~~~~~~~~
############################

# Country Count
###############
country1 <- qualifying_studies  %>% 
  # Set Up
  # ------
  filter(!is.na(country)) %>%
  # Plotting
  # --------
  ggplot(aes(x = reorder(country, country, 
                         FUN = function(x) -length(x)))) + 
  geom_bar() +
  # Labeling
  #---------
  geom_text(stat = "count", aes(label = after_stat(count)), 
            vjust = -0.21, size = 3, color = "black") +
  labs(
    title = "Country Sample Count Distribution", 
    x = "Country (NATO country code, trigram)", 
    y = "Count") +
  theme( 
        legend.position = "none", 
        plot.title = element_text(size = 12))

# Country Fill
##############
country2 <- qualifying_studies  %>% 
  # Set Up
  # ------
  filter(!is.na(country)) %>%
  # Plotting
  # --------
  ggplot(aes(x = reorder(country, country, 
                         FUN = function(x) -length(x)), 
             fill=disease_class)) + 
  geom_bar() +
  scale_fill_manual(values = progression_colors, 
                    name = "CRC Progression Classifiers") +
  # Labeling
  #---------
  labs(title = "Country Sample Count Distribution",
       subtitle = "with CRC Progression Classifiers",
       x = "Country (NATO country code, trigram)", 
       y = "Count") +
  theme( 
        legend.position = "none", 
        plot.title = element_text(size = 12))

# Countries Proportions
#######################
country3 <- qualifying_studies %>% 
  # Set Up
  # ------
  filter(!is.na(country)) %>%
  # Plotting
  # --------
  ggplot(aes(x = reorder(country, country, 
                         FUN = function(x) -length(x)), fill = disease_class)) + 
  geom_bar(position = "fill") +
  scale_fill_manual(values = progression_colors, 
                    name = "CRC Progression Classifiers") +
  # Labeling
  #---------
  labs(
    title = "Proportion of CRC Progression Per Country", 
    x = "Country (NATO country code, trigram)", 
    y = "Proportion") +
  theme( 
        plot.title = element_text(size = 12))


# Display
#########
layout3 <- c( # t, l , b = t, r = l
  area(1, 1, 2, 2),
  area(1, 3, 2, 4),
  area(1, 5, 2, 6)
)

#plot(layout3)

geography_caption <- str_wrap(
  "(A) Bar plot of country sample count, sorted in descending order. 
   (B) Stacked bar plot of country sample count, sorted in descending order, filled with CRC progression classifiers.
   (C) Stacked bar plot of the CRC progression classifier proportion for each country in the multi-cohort study.", 
  width = 200
)

country1 + country2 + country3 + 
  plot_layout(design = layout3, guides = "collect", heights = c(1, 0.18)) +
  plot_annotation(
    title = "Figure 2: Country Associations with CRC Progression Classifiers",
    tag_levels = "A",
    caption = geography_caption
  ) &
  theme(
        plot.title = element_text(hjust = 0, size = 14),
        plot.caption = element_text(hjust = 0, size = 11), 
        legend.key.size = unit(0.5, "cm"),
        legend.title = element_text(size = 10), 
        legend.direction = "vertical", 
        legend.position = "right"
  )
```

BMI has been previously associated with microbial shifts (Li et al., 2025) and should be heavily considered when modelling. We examined the distribution of the BMI among the CRC progression classifiers (Figure 3-A) and while there were a few outliers, particularly in the upper BMI bounds of the "PA", "PA+", and "CRC" classifiers, there are visually striking differences among the means of the groupings, particularly those with comorbidities. To confirm, an ANOVA was run (Appendix 3-C) which was found to be statistically significant (95% confidence, p = \<2e-16), warranting a Tukey's HSD for further investigation. Of 21 pairings, 13 were found to be statistically significant to a 95% confidence level, meaning BMI could have an impact. It appears to have the most impact on "CRC-H" (5 pairings), "Other" (4 pairings), and "CRC" (4 pairings). BMI and age are also known to influence each other, thus it was decided to check if there would be any clustering or relationship visible when plotted against one another, shown in Figure 3-B. Associated linear models were conducted for each CRC progression classifier to check for potential relationships, which are also represented on the scatter plots (Appendix 3-D). Results of the age-centered, linear regression modelling shows a very low R-squared value of 0.0707, meaning that BMI and age only explains about 7% of the variance, though there are a few relationships that show statistical significance to a 95% confidence level, such as in "CRC-H" and "Other". With such a low explanation of the variance, it would be interesting to see how this may or may not extend towards the taxonomic and pathway relationships in the gut microbiome.

```{r, echo=FALSE}
#| label: BMI Associations
#| fig-width: 14
#| fig-height: 7
#| fig-dpi: 500
# ---

# BMI ~~~~~~~~~~~~~~~~~~~~~~
############################

# Box Plot 
##########
bmi1 <- qualifying_studies %>%   
  # Set Up   
  # ------   
  filter(!is.na(BMI)) %>%   
  # Plotting   
  # --------   
  ggplot(aes(x=disease_class, y=BMI)) +    
  geom_boxplot(outlier.shape = NA) +   
  geom_jitter(alpha = 0.15, width = 0.15) +   
  stat_summary(fun = mean, geom = "point", shape = 20, size = 5, color = "red") +
  # Labeling   
  #--------- 
  labs(
    title = "Distribution of BMI by CRC Progression Classifier", 
    x = "CRC Progression Classifiers", 
    y = "BMI"
  ) +
  theme(plot.title = element_text(size = 12))
    

# Scatterplot by CRC Progression 
################################
bmi2 <- qualifying_studies %>% 
  # Set Up   
  # ------   
  filter (!is.na(age), !is.na(BMI)) %>% 
  # Plotting   
  # --------   
  ggplot(aes(x=age, y=BMI)) +    
  geom_point(aes(color = disease_class, alpha = 0.7)) + 
  geom_smooth(method = "lm", se = TRUE, formula = y ~ x, color = "grey40") +
  scale_color_manual(values = progression_colors, 
                     name = "CRC Progression Classifiers") +
  facet_wrap(~disease_class) +
  # Labeling   
  #---------  
  labs(
    title = "Age by BMI, Colored by CRC Progression Classifier", 
    x = "Age", 
    y = "BMI"
  ) +
  theme(plot.title = element_text(size = 12), 
        legend.position = "none")

# Display
#########
layout2 <- c( # t, l , b = t, r = l
  area(1, 1, 2, 3), 
  area(1, 4, 2, 6)
)

#plot(layout2)

BMI_caption <- str_wrap(
  "(A) Box plot of BMI by CRC progression classifier. The red dot marks the mean, while the black line marks the median. All classifiers generally have a normal distribution.
   (B) Scatter plots of age by BMI, with a linear model regression line of y ~ x, faceted by CRC progression classifier. Notice that there is minimally notable clustering.", 
  width = 200
)

bmi1 + bmi2 +
  plot_layout(design = layout2) +
  plot_annotation(
    title = "Figure 3: BMI Associations with CRC Progression Classifiers",
    tag_levels = "A",
    caption = BMI_caption
  ) &
  theme(
        plot.title = element_text(hjust = 0, size = 14),
        plot.caption = element_text(hjust = 0, size = 12), 
        legend.key.size = unit(0.5, "cm"), 
        legend.title = element_text(size = 10), 
        legend.direction = "horizontal"
  )
```

#### Taxonomic & Pathway Analysis

The combined filtered data sets from cMD3 contain over 1000 taxa. To identify any trends in the data, we looked at beta-diversity, which is a test for dissimilarity between the study conditions. Although the p-value was highly significant (P = 0.001), the R-squared value (R\^2 = 0.0078) indicates much of the dissimilarity is not explained by the study conditions.

```{r}
#| label: PCoA Plot
#| echo: false
#| message: false
#| warning: false
#| fig-align: center
#| fig-height: 6
#| fig-width: 14

data <- returnSamples(
  qualifying_studies,
  dataType = "relative_abundance",
  counts = TRUE
)

# Calculate distance matrix
dist_matrix <- vegdist(t(assay(data, "relative_abundance")), 
                       method = "bray")

# Get metadata
metadata <- colData(data) %>% as.data.frame()

# PERMANOVA test
permanova_result <- adonis2(dist_matrix ~ study_condition, 
                            data = metadata, 
                            permutations = 999)

# Extract R-squared and p-value
r_squared <- permanova_result$R2[1]
p_value <- permanova_result$`Pr(>F)`[1]

data %>% 
  agglomerateByRanks() %>%
  runMDS(FUN = vegdist, method = "bray", exprs_values = "relative_abundance", altexp = "genus", name = "BrayCurtis") %>%
  plotReducedDim("BrayCurtis", colour_by = "study_condition", shape_by = "age_decade") +
  labs(x = "PCo 1", y = "PCo 2",
       subtitle = glue::glue("PERMANOVA: R² = {round(r_squared, 4)}, p = {round(p_value, 4)}")) +
  guides(colour = guide_legend(title = "Study Condition"), shape = guide_legend(title = "Age (by decade)")) +
  theme(legend.position = c(0.01, 0.28),
        axis.text = element_text(size = 12),
        axis.title = element_text(size = 14),
        legend.text = element_text(size = 12),
        legend.title = element_text(size = 13),
        plot.subtitle = element_text(size = 12))

```

To understand how the taxa are distributed across the different study conditions, two relative abundance plots were generated at the family and genus level.

```{r}
#| label: Taxon by Condition, Genus and Family
#| echo: false
#| warning: false
#| message: false
#| fig-width: 14
#| fig-height: 6
#| fig-align: center

data <- returnSamples(
  qualifying_studies,
  dataType = "relative_abundance",
  counts = TRUE
)

fareblind15 <- c("#000000","#004949","#009292","#FF6DB6","#FFB6DB",
                   "#490092","#006DDB","#B66DFF","#6DB6FF","#B6DBFF",
                   "#920000","#924900","#DB6D00","#24FF24","#FFFF6D") 

# Extract and aggregate
abund_data <- assay(data, "relative_abundance")
sample_meta <- colData(data) %>% as.data.frame()
tax_data <- rowData(data) %>% as.data.frame()

# Convert to long format
abund_long <- abund_data %>%
  as.data.frame() %>%
  rownames_to_column("taxon") %>%
  pivot_longer(-taxon, names_to = "sample", values_to = "abundance")

# Add metadata
sample_meta$sample <- rownames(sample_meta)

# Merge and aggregate
abund_agg <- abund_long %>%
  merge(sample_meta[, c("sample", "study_condition")], by = "sample") %>%
  group_by(taxon, study_condition) %>%
  summarise(abundance = mean(abundance), .groups = "drop")

#######################################################
#Group by
# Extract genus level
abund_long_genus <- abund_data %>%
  as.data.frame() %>%
  rownames_to_column("taxon") %>%
  mutate(genus = str_extract(taxon, "g__[^|]*")) %>%  # Extract genus
  mutate(genus = str_remove(genus, "g__")) %>%  # Remove the g__ prefix
  pivot_longer(-c(taxon, genus), names_to = "sample", values_to = "abundance")

# Then aggregate by genus instead of taxon
abund_agg <- abund_long_genus %>%
  merge(sample_meta[, c("sample", "study_condition")], by = "sample") %>%
  group_by(genus, study_condition) %>%
  summarise(abundance = sum(abundance), .groups = "drop")  # Sum instead of mean

# Get top 15 genera
top_genera <- abund_long_genus %>%
  group_by(genus) %>%
  summarise(mean_abund = mean(abundance)) %>%
  arrange(desc(mean_abund)) %>%
  slice_head(n = 15) %>%
  pull(genus)

# Filter and normalize
abund_normalized <- abund_agg %>%
  filter(genus %in% top_genera) %>%
  group_by(study_condition) %>%
  mutate(relative_abundance = abundance / sum(abundance)) %>%
  ungroup()

# Plot
p1 <- abund_normalized %>%
  ggplot(aes(x = study_condition, y = relative_abundance, fill = genus)) +
  geom_col() +
  scale_fill_manual(values = fareblind15) +
  coord_flip() +
  ggtitle("Gut microbiota by condition (Genus level)") +
  theme_minimal()


######################################
# Group by Family
abund_long_family <- abund_data %>%
  as.data.frame() %>%
  rownames_to_column("taxon") %>%
  mutate(family = str_extract(taxon, "f__[^|]*")) %>%  # Extract family
  mutate(family = str_remove(family, "f__")) %>%  # Remove the g__ prefix
  pivot_longer(-c(taxon, family), names_to = "sample", values_to = "abundance")

# Then aggregate by family instead of taxon
abund_agg <- abund_long_family %>%
  merge(sample_meta[, c("sample", "study_condition")], by = "sample") %>%
  group_by(family, study_condition) %>%
  summarise(abundance = sum(abundance), .groups = "drop")  # Sum instead of mean

# Get top 15 genera
top_genera <- abund_long_family %>%
  group_by(family) %>%
  summarise(mean_abund = mean(abundance)) %>%
  arrange(desc(mean_abund)) %>%
  slice_head(n = 15) %>%
  pull(family)

# Filter and normalize
abund_normalized <- abund_agg %>%
  filter(family %in% top_genera) %>%
  group_by(study_condition) %>%
  mutate(relative_abundance = abundance / sum(abundance)) %>%
  ungroup()

# Plot
p2 <- abund_normalized %>%
  ggplot(aes(x = study_condition, y = relative_abundance, fill = family)) +
  geom_col() +
  scale_fill_manual(values = fareblind15) +
  coord_flip() +
  ggtitle("Gut microbiota by condition (Family level)") +
  theme_minimal()

figure_2_caption <- str_wrap(
  "(A) Study condition
   (B) Histogram demonstrating a bimodal age distribution with a secondary peak near 25 years and a primary peak near 60 years.",
  width = 120
)


p2 + p1 + plot_layout(ncol = 2)  # Side by side
```

The relative abundance stacked bar plots also indicate there was very little difference at the family and genus taxonomic levels. Considering these data sets cover several countries and age categories, it is possible that further separation into more groups may provide better comparisons. As Japan and the United States contain the greatest number of participants, these countries were separated out. Then, for the same reason, we compared only the control and CRC groups, since these health conditions also have the highest sample sizes. To identify key differences in how taxa may be enriched between groups, differential abundance was looked at using LEfSe analysis. Using a reference and a treatment, LEfSe performs Kruskal-Wallis test to identify taxa that were statistically different from zero between the control and CRC groups. Taxa found to be statistically significant were run with a Wilconox Rank-Sum Test to perform pairwise comparisons. Finally, the effect size is calculated using linear distriminant analysis (LDA).

```{r}
#| label: Taxon by Country
#| echo: false
#| warning: false
#| message: false
#| fig-width: 14
#| fig-height: 6
#| fig-align: center

#Filter data for Japan
data_JPN <- data[, data$country == "JPN"]

data_JPN <- data_JPN[, data_JPN$study_condition == c("control","CRC")]

data_JPN_genus <- agglomerateByRank(data_JPN, rank = "genus")


p1b <- lefser(
  relativeAb(data_JPN_genus),
  kruskal.threshold = 0.05,
  wilcox.threshold = 0.05,
  lda.threshold = 2,
  classCol = "study_condition",
  subclassCol = NULL,
  assay = 1L,
  trim.names = FALSE,
  checkAbundances = TRUE
) %>%
  lefserPlot() +
  labs(title = "Japan - CRC vs Control", subtitle = "LEfSe Analysis")

#Filter data for United States
data_USA <- data[, data$country == "USA"]

data_USA <- data_USA[, data_USA$study_condition == c("control","CRC")]

data_USA_genus <- agglomerateByRank(data_USA, rank = "genus")


p2b <- lefser(
  relativeAb(data_USA_genus),
  kruskal.threshold = 0.05,
  wilcox.threshold = 0.05,
  lda.threshold = 2,
  classCol = "study_condition",
  subclassCol = NULL,
  assay = 1L,
  trim.names = FALSE,
  checkAbundances = TRUE
) %>%
  lefserPlot() +
  labs(title = "United States = CRC vs Control")

# Save lefser results before plotting
res_JPN <- lefser(
  relativeAb(data_JPN_genus),
  kruskal.threshold = 0.05,
  wilcox.threshold = 0.05,
  lda.threshold = ,
  classCol = "study_condition"
)

res_USA <- lefser(
  relativeAb(data_USA_genus),
  kruskal.threshold = 0.05,
  wilcox.threshold = 0.05,
  lda.threshold = 2,
  classCol = "study_condition"
)

# Filter for CRC-associated taxa (positive LDA scores, assuming CRC is the positive class)
crc_JPN <- res_JPN[res_JPN$scores > 0, "features"]
crc_USA <- res_USA[res_USA$scores > 0, "features"]

p1b + p2b

# Find common taxa
intersect(crc_JPN, crc_USA)

bugsInCommon <- intersect(crc_JPN, crc_USA)

```

Three genera (Blautia, Collinsella, and Dorea) were found to have greater abundance in CRC samples compared to controls. This warrants further investigation....

#### Data Limitations

While this work assesses the feasibility of leveraging human gut microbiome “fingerprints” for disease-state characterization, limitations do still exist from data availability, metadata completeness, and necessary inclusion criteria. All of which are not unique to this study but rather showcase the current challenges amongst large scale microbiome meta-analyses. 

A rather major limitation is the incomplete availability of clinically and biologically relevant metadata across the various studies in our analysis. The metadata completeness analysis shown below visualises this. There is only a subset of variables that are consistently available throughout the data such as the sequencing platform use, participant country, gender, age and age by decade, BMI, and disease class. This is unfortunate because it is known that the microbiome is drastically influenced by variables that are not consistent such as antibiotic use, smoking status, alcohol consumption, and disease stages [(Tegegne & Savidge, 2025)](https://www.zotero.org/google-docs/?OPR4V4). The original use case was intended to be applied to antibiotic usage which will unfortunately need to be pushed until more complete data sets are available. 

```{r, echo=FALSE}

#| label: Metadata heat map 


#creating a metadata heatmap showing some variables that aren't used downstream
meta_vars <- c(
  # Demographics
  "age", "age_decade", "gender", "BMI",
  
  # Lifestyle / exposures
  "diet", "alcohol", "alcohol_numeric", "smoker", "ever_smoker",
  "antibiotics_current_use",
  
  # Clinical context
  "disease_class", "disease_stage", "disease_location",
  
  # Geography
  "country", "location", "population",
  
  # Technical
  "sequencing_platform", "DNA_extraction_kit",
  
  # Timing
  "days_from_first_collection", "days_after_onset"
)

# Confirm they exist
#meta_vars[meta_vars %in% colnames(qualifying_studies)]

#compute metadata completeness (percent of non-mising data)

meta_completeness <- qualifying_studies %>%
  summarise(across(all_of(meta_vars), ~ mean(!is.na(.)))) %>%
  pivot_longer(
    cols = everything(),
    names_to = "variable",
    values_to = "completeness"
  ) %>%
  mutate(completeness = completeness * 100)

#print(meta_completeness)

#create a heatmap for metadata completeness 
#library(ggplot2)
meta_completeness <- meta_completeness %>%
  arrange(completeness) %>%
  mutate(variable = factor(variable, levels = variable))

ggplot(meta_completeness,
       aes(x = "", y = variable, fill = completeness)) +
  geom_tile(color = "white") +
  scale_fill_gradient(
    low = "white",
    high = "steelblue",
    limits = c(0, 100),
    name = "% samples\nwith data"
  ) +
  labs(
    title = str_wrap("Metadata Completeness in CRC Related Metagenomic Samples"),
    subtitle = str_wrap("Percent of samples with non-missing values per variable"),
    x = NULL,
    y = NULL
  ) +
  theme_bw() +
  theme(
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank(),
    #center justify titles
    plot.title = element_text(face = "bold", size = 12, hjust=0.5),
    plot.subtitle = element_text(size = 10, hjust=0.5)
  )
```

While this study focuses on CRC metagenomic analysis/”fingerprinting”, the available data has either empty or missing columns for things like tumor stage, location, and metastasis. Original plans had the separation of CRC patients with and without metastasis which is currently not feasible until more complete data is available. This will result in a computational framework that can only compare broad disease categories rather than detailed cancer stages. 

Other limitations came about after the filtering of the dataset to keep data consistent and comparable. Filters included only adult patients, stool samples only, disease labels, and CRC relevant studies. While the data quality is better using these filters, it does shrink the dataset. The filtering created a working database with mostly CRC samples where polyp-only and adenoma cases are few and far between. Due to this, disease progression from polyp to cancer modeling will not be reliable. Again this leads to a focus on broad comparisons such as healthy participants vs early lesions vs CRC. 

As this dataset is a compilation, there are other considerations to factor in, specifically the difference in laboratory techniques, sequencing machines, extraction kits, and protocols used throughout all of the studies. These variables are documented but they cannot be fully corrected for so they must be mentioned as they create biological noise in an exploratory modeling approach such as this

```{r, echo=FALSE}
#| label: Sequencing variations


#create ggplot of studies selected and sequencing platform and extraction kit used
#summary table with counts per study X
study_tech_summary <- qualifying_studies %>%
  filter(
    !is.na(sequencing_platform),
    !is.na(DNA_extraction_kit)
  ) %>%
  count(study_name, sequencing_platform, DNA_extraction_kit)
    #sanity check lol
#head(study_tech_summary)
#create ggplot
ggplot(
  study_tech_summary,
  aes(
    y = study_name,
    x = n,
    fill = DNA_extraction_kit
  )
) +
  geom_col() +
  facet_wrap(~ sequencing_platform, scales = "free_y") +
  theme_bw() +
  labs(
    title = str_wrap("Sequencing Platforms and DNA Extraction Kits Across CRC-Relevant Studies", width = 50),
    x = "Number of samples",
    y = "Study name",
    fill = "DNA extraction kit"
  ) +
  theme(
    # Centers the main title
    plot.title = element_text(hjust = 0.5, face = "bold")
  )
```

Proposal of this analytical framework is intentionally framed as a proof-of-concept tool rather than a ready to use clinically diagnostic model to show the idea works in principle. Biggest limitations currently include missing or inconsistent metadata, not from the modeling itself. This is to say that when future datasets with more consistent data become available the framework can handle expansions.

### Conclusion

### References
