filter(!is.na(age), !is.na(gender)) %>%
# Plotting
# --------
ggplot(aes(x = age_decade), fill = disease_class) +
geom_bar() +
scale_fill_manual(values = progression_colors, name = "CRC Progression") +
facet_wrap(~gender) +
# Labeling
#---------
ggtitle("Distribution of Age") +
labs(x = "Age", y = "Count") +
theme(axis.text.x = element_text(angle = 25, hjust = 1, lineheight = 1.1))
# Gendered Barplot: Proportions
###############################
qualifying_studies %>%
# Set Up
# ------
filter(!is.na(age), !is.na(gender)) %>%
# Plotting
# --------
ggplot(aes(x = age_decade, fill = disease_class)) +
geom_bar(position = "fill") +
scale_fill_manual(values = progression_colors, name = "CRC Progression") +
facet_wrap(~gender) +
# Labeling
#---------
ggtitle("Distribution of Age") +
labs(x = "Age", y = "Count") +
theme(axis.text.x = element_text(angle = 25, hjust = 1, lineheight = 1.1))
################################################################################
## ---- 1) Load packages
suppressPackageStartupMessages({
library(BiocManager)
library(curatedMetagenomicData)
library(dplyr)
library(stringr)
})
#View(sampleMetadata)
str(sampleMetadata)
################################################################################
## ---- 2) Quick environment sanity check
cat("\n=== Session Info ===\n")
cat("R:", R.version.string, "\n")
cat("Bioc:", as.character(BiocManager::version()), "\n")
cat("Library paths:\n")
print(.libPaths())
cat("\ncuratedMetagenomicData:", as.character(packageVersion("curatedMetagenomicData")), "\n\n")
sampleMetadata <- sampleMetadata %>%
mutate(
age_decade = case_when(
age < 10 ~ "0-9",
age > 9 & age < 20 ~ "10-19",
age > 19 & age < 30 ~ "20-29",
age > 29 & age < 40 ~ "30-39",
age > 39 & age < 50 ~ "40-49",
age > 49 & age < 60 ~ "50-59",
age > 59 & age < 70 ~ "60-69",
age > 69 & age < 80 ~ "70-79",
age > 79 & age < 90 ~ "80-89",
age > 89 ~ "90+"
)
)
################################################################################
qualifying_studies <- sampleMetadata %>%
filter(body_site == "stool", age >= 18, !is.na(disease)) %>%
group_by(study_name) %>%
filter(
any(str_detect(disease, "\\bCRC\\b") | str_detect(disease, "polyp|adenoma")) |
any(study_name == "HMP_2012")
) %>%
ungroup() %>%
mutate(
disease_class = case_when(
disease == "healthy" ~ "HC",
disease %in% c("adenoma", "few_polyps") ~ "PA",
str_detect(disease, "\\b(adenoma|polyp)\\b") ~ "PA+",
str_detect(disease, "\\b(adenoma|polyp)\\b") & str_detect(disease, "metasta") ~ "PA-M",
disease == "CRC" ~ "CRC",
str_detect(disease, "\\bCRC\\b") ~ "CRC+",
str_detect(disease, "history") ~ "CRC-H",
str_detect(disease, "\\bCRC\\b") & str_detect(disease, "metasta") ~ "CRC-M",
TRUE ~ "Other"
)
) %>%
mutate(
disease_class = factor(
disease_class,
levels = c(
"Other",
"HC",
"PA",
"PA+",
"PA-M",
"CRC",
"CRC+",
"CRC-H",
"CRC-M"
)
)
) %>%
mutate(
age_decade = if_else(age_decade == "10-19" | age_decade == "20-29", "18-29", age_decade)
) %>%
select(
study_name, subject_id, antibiotics_current_use,
age, age_category, age_decade, gender, BMI, smoker, ever_smoker, alcohol, alcohol_numeric, diet, country, location, population,
study_condition, disease, disease_class, disease_subtype, disease_stage, disease_location, days_from_first_collection, days_after_onset,
sequencing_platform, DNA_extraction_kit,
cholesterol, wbc, rbc, stool_texture)
View(qualifying_studies)
cat("\n=== Qualifying Studies ===\n")
cat("Qualifying Studies samples (all):", nrow(qualifying_studies), "\n")
cat("Qualifying Studies samples (healthy):", qualifying_studies %>% filter(disease == "healthy") %>% nrow(), "\n")
cat("Qualifying Studies samples (disease):", qualifying_studies %>% filter(disease != "healthy") %>% nrow(), "\n")
cat("Qualifying Studies:", length(unique(qualifying_studies$study_name)), "\n")
cat("Study Sample Counts in Qualifying Studies:\n")
print(head(sort(table(qualifying_studies$study_name), decreasing = TRUE), 15))
cat("Top diseases in Qualifying Studies:\n")
print(head(sort(table(qualifying_studies$disease_class), decreasing = TRUE), 35))
#| label: Setup
# ---
suppressPackageStartupMessages({
library(ggplot2)
library(dplyr)
library(knitr)
library(patchwork)
})
progression_order <- c(
"Other",
"HC",
"PA",
"PA+",
"PA-M",
"CRC",
"CRC+",
"CRC-H",
"CRC-M"
)
progression_colors <- c(
"HC" = "#539deb",
"PA" = "#e4e85b",
"PA+" = "#e8a25b",
"CRC" = "#cf1919",
"CRC+" = "#8f0000",
"CRC-M" = "#4d0404",
"CRC-H" = "#520f76",
"Other" = "#aaa3a3"
)
qualifying_studies <- qualifying_studies %>%
mutate(
disease_class = factor(disease_class, levels = progression_order)
)
#| label: Gendered Disease Comparisons
# ---
# Gender By Disease Category
############################
qualifying_studies %>%
# Set-up
# ------
filter(!is.na(age), !is.na(gender)) %>%
# Plotting
# --------
ggplot(aes(x=gender)) +
geom_bar() +
# Labeling
#---------
ggtitle("Distribution of CRC Progression \n Categorization by Gender") +
labs(x = "Age", y = "Count") +
theme(axis.text.x = element_text(angle = 25, hjust = 1, lineheight = 1.1))
# Gendered Barplot: Counts
##########################
qualifying_studies %>%
# Set Up
# ------
filter(!is.na(age), !is.na(gender)) %>%
# Plotting
# --------
ggplot(aes(x = age_decade), fill = disease_class) +
geom_bar() +
scale_fill_manual(values = progression_colors, name = "CRC Progression") +
facet_wrap(~gender) +
# Labeling
#---------
ggtitle("Distribution of Age") +
labs(x = "Age", y = "Count") +
theme(axis.text.x = element_text(angle = 25, hjust = 1, lineheight = 1.1))
# Gendered Barplot: Proportions
###############################
qualifying_studies %>%
# Set Up
# ------
filter(!is.na(age), !is.na(gender)) %>%
# Plotting
# --------
ggplot(aes(x = age_decade, fill = disease_class)) +
geom_bar(position = "fill") +
scale_fill_manual(values = progression_colors, name = "CRC Progression") +
facet_wrap(~gender) +
# Labeling
#---------
ggtitle("Distribution of Age") +
labs(x = "Age", y = "Count") +
theme(axis.text.x = element_text(angle = 25, hjust = 1, lineheight = 1.1))
#| label: Gendered Disease Comparisons
# ---
# Gender By Disease Category
############################
qualifying_studies %>%
# Set-up
# ------
filter(!is.na(age), !is.na(gender)) %>%
# Plotting
# --------
ggplot(aes(x=gender)) +
geom_bar() +
# Labeling
#---------
ggtitle("Distribution of CRC Progression \n Categorization by Gender") +
labs(x = "Age", y = "Count") +
theme(axis.text.x = element_text(angle = 25, hjust = 1, lineheight = 1.1))
# Gendered Barplot: Counts
##########################
qualifying_studies %>%
# Set Up
# ------
filter(!is.na(age), !is.na(gender)) %>%
# Plotting
# --------
ggplot(aes(x = age_decade, fill = disease_class)) +
geom_bar() +
scale_fill_manual(values = progression_colors, name = "CRC Progression") +
facet_wrap(~gender) +
# Labeling
#---------
ggtitle("Distribution of Age") +
labs(x = "Age", y = "Count") +
theme(axis.text.x = element_text(angle = 25, hjust = 1, lineheight = 1.1))
# Gendered Barplot: Proportions
###############################
qualifying_studies %>%
# Set Up
# ------
filter(!is.na(age), !is.na(gender)) %>%
# Plotting
# --------
ggplot(aes(x = age_decade, fill = disease_class)) +
geom_bar(position = "fill") +
scale_fill_manual(values = progression_colors, name = "CRC Progression") +
facet_wrap(~gender) +
# Labeling
#---------
ggtitle("Distribution of Age") +
labs(x = "Age", y = "Count") +
theme(axis.text.x = element_text(angle = 25, hjust = 1, lineheight = 1.1))
#| label: Gendered Disease Comparisons
# ---
# Gender By Disease Category
############################
qualifying_studies %>%
# Set-up
# ------
filter(!is.na(age), !is.na(gender)) %>%
# Plotting
# --------
ggplot(aes(x=gender, fill=disease_class)) +
geom_bar() +
# Labeling
#---------
ggtitle("Distribution of CRC Progression \n Categorization by Gender") +
labs(x = "Age", y = "Count") +
theme(axis.text.x = element_text(angle = 25, hjust = 1, lineheight = 1.1))
# Gendered Barplot: Counts
##########################
qualifying_studies %>%
# Set Up
# ------
filter(!is.na(age), !is.na(gender)) %>%
# Plotting
# --------
ggplot(aes(x = age_decade, fill = disease_class)) +
geom_bar() +
scale_fill_manual(values = progression_colors, name = "CRC Progression") +
facet_wrap(~gender) +
# Labeling
#---------
ggtitle("Distribution of Age") +
labs(x = "Age", y = "Count") +
theme(axis.text.x = element_text(angle = 25, hjust = 1, lineheight = 1.1))
# Gendered Barplot: Proportions
###############################
qualifying_studies %>%
# Set Up
# ------
filter(!is.na(age), !is.na(gender)) %>%
# Plotting
# --------
ggplot(aes(x = age_decade, fill = disease_class)) +
geom_bar(position = "fill") +
scale_fill_manual(values = progression_colors, name = "CRC Progression") +
facet_wrap(~gender) +
# Labeling
#---------
ggtitle("Distribution of Age") +
labs(x = "Age", y = "Count") +
theme(axis.text.x = element_text(angle = 25, hjust = 1, lineheight = 1.1))
#| label: Gendered Disease Comparisons
# ---
# Gender By Disease Category
############################
qualifying_studies %>%
# Set-up
# ------
filter(!is.na(age), !is.na(gender)) %>%
# Plotting
# --------
ggplot(aes(x=gender, fill=disease_class)) +
geom_bar(position = "fill") +
# Labeling
#---------
ggtitle("Proportions of CRC Progression Categorization by Gender") +
labs(x = "Age", y = "Proportion") +
theme(axis.text.x = element_text(angle = 25, hjust = 1, lineheight = 1.1))
# Gendered Barplot: Counts
##########################
qualifying_studies %>%
# Set Up
# ------
filter(!is.na(age), !is.na(gender)) %>%
# Plotting
# --------
ggplot(aes(x = age_decade, fill = disease_class)) +
geom_bar() +
scale_fill_manual(values = progression_colors, name = "CRC Progression") +
facet_wrap(~gender) +
# Labeling
#---------
ggtitle("Distribution of Age") +
labs(x = "Age", y = "Count") +
theme(axis.text.x = element_text(angle = 25, hjust = 1, lineheight = 1.1))
# Gendered Barplot: Proportions
###############################
qualifying_studies %>%
# Set Up
# ------
filter(!is.na(age), !is.na(gender)) %>%
# Plotting
# --------
ggplot(aes(x = age_decade, fill = disease_class)) +
geom_bar(position = "fill") +
scale_fill_manual(values = progression_colors, name = "CRC Progression") +
facet_wrap(~gender) +
# Labeling
#---------
ggtitle("Distribution of Age") +
labs(x = "Age", y = "Count") +
theme(axis.text.x = element_text(angle = 25, hjust = 1, lineheight = 1.1))
#| label: Gendered Disease Comparisons
# ---
# Gender By Disease Category
############################
qualifying_studies %>%
# Set-up
# ------
filter(!is.na(age), !is.na(gender)) %>%
# Plotting
# --------
ggplot(aes(x=gender, fill=disease_class)) +
geom_bar(position = "fill") +
scale_fill_manual(values = progression_colors, name = "CRC Progression") +
# Labeling
#---------
ggtitle("Proportions of CRC Progression Categorization by Gender") +
labs(x = "Age", y = "Proportion") +
theme(axis.text.x = element_text(angle = 25, hjust = 1, lineheight = 1.1))
# Gendered Barplot: Counts
##########################
qualifying_studies %>%
# Set Up
# ------
filter(!is.na(age), !is.na(gender)) %>%
# Plotting
# --------
ggplot(aes(x = age_decade, fill = disease_class)) +
geom_bar() +
scale_fill_manual(values = progression_colors, name = "CRC Progression") +
facet_wrap(~gender) +
# Labeling
#---------
ggtitle("Distribution of Age") +
labs(x = "Age", y = "Count") +
theme(axis.text.x = element_text(angle = 25, hjust = 1, lineheight = 1.1))
# Gendered Barplot: Proportions
###############################
qualifying_studies %>%
# Set Up
# ------
filter(!is.na(age), !is.na(gender)) %>%
# Plotting
# --------
ggplot(aes(x = age_decade, fill = disease_class)) +
geom_bar(position = "fill") +
scale_fill_manual(values = progression_colors, name = "CRC Progression") +
facet_wrap(~gender) +
# Labeling
#---------
ggtitle("Distribution of Age") +
labs(x = "Age", y = "Count") +
theme(axis.text.x = element_text(angle = 25, hjust = 1, lineheight = 1.1))
#| label: Gendered Disease Comparisons
# ---
# Gender By Disease Category
############################
qualifying_studies %>%
# Set-up
# ------
filter(!is.na(age), !is.na(gender)) %>%
# Plotting
# --------
ggplot(aes(x=gender, fill=disease_class)) +
geom_bar(position = "fill") +
scale_fill_manual(values = progression_colors, name = "CRC Progression") +
# Labeling
#---------
ggtitle("Proportions of CRC Progression Categorization by Gender") +
labs(x = "Age", y = "Proportion") +
theme(axis.text.x = element_text(angle = 25, hjust = 1, lineheight = 1.1))
# Gendered Barplot: Counts
##########################
qualifying_studies %>%
# Set Up
# ------
filter(!is.na(age), !is.na(gender)) %>%
# Plotting
# --------
ggplot(aes(x = age_decade, fill = disease_class)) +
geom_bar() +
scale_fill_manual(values = progression_colors, name = "CRC Progression") +
facet_wrap(~gender) +
# Labeling
#---------
ggtitle("Distribution of Age") +
labs(x = "Age", y = "Count") +
theme(axis.text.x = element_text(angle = 25, hjust = 1, lineheight = 1.1))
# Gendered Barplot: Proportions
###############################
qualifying_studies %>%
# Set Up
# ------
filter(!is.na(age), !is.na(gender)) %>%
# Plotting
# --------
ggplot(aes(x = age_decade, fill = disease_class)) +
geom_bar(position = "fill") +
scale_fill_manual(values = progression_colors, name = "CRC Progression") +
facet_wrap(~gender) +
# Labeling
#---------
ggtitle("Distribution of Age") +
labs(x = "Age", y = "Proportion") +
theme(axis.text.x = element_text(angle = 25, hjust = 1, lineheight = 1.1))
#| label: Gendered Disease Comparisons
# ---
# Gender By Disease Category
############################
qualifying_studies %>%
# Set-up
# ------
filter(!is.na(age), !is.na(gender)) %>%
# Plotting
# --------
ggplot(aes(x=gender, fill=disease_class)) +
geom_bar(position = "fill") +
scale_fill_manual(values = progression_colors, name = "CRC Progression") +
# Labeling
#---------
ggtitle("Proportions of CRC Progression Categorization by Gender") +
labs(x = "Age", y = "Proportion") +
theme(axis.text.x = element_text(angle = 25, hjust = 1, lineheight = 1.1))
# Gendered Barplot: Counts
##########################
qualifying_studies %>%
# Set Up
# ------
filter(!is.na(age), !is.na(gender)) %>%
# Plotting
# --------
ggplot(aes(x = age_decade, fill = disease_class)) +
geom_bar() +
scale_fill_manual(values = progression_colors, name = "CRC Progression") +
facet_wrap(~gender) +
# Labeling
#---------
ggtitle("Distribution of Age") +
labs(x = "Age", y = "Count") +
theme(axis.text.x = element_text(angle = 25, hjust = 1, lineheight = 1.1))
# Gendered Barplot: Proportions
###############################
qualifying_studies %>%
# Set Up
# ------
filter(!is.na(age), !is.na(gender)) %>%
# Plotting
# --------
ggplot(aes(x = age_decade, fill = disease_class)) +
geom_bar(position = "fill") +
scale_fill_manual(values = progression_colors, name = "CRC Progression") +
facet_wrap(~gender) +
# Labeling
#---------
ggtitle("Distribution of Age") +
labs(x = "Age", y = "Proportion") +
theme(axis.text.x = element_text(angle = 25, hjust = 1, lineheight = 1.1))
